# Redis进阶部分


## 学习帮助

[通义AI](https://tongyi.aliyun.com/)

## * Redis配置文件

配置文件在安装的目录下的**Redis.conf**

如果你用的**Windows版本**，那么会有两个：**redis.windows-service.conf**和redis.windows.conf两个文件，修改前者即可

1. 该配置文件对**大小不敏感**
2. 可以导入**外部配置文件**![配置文件](../../图床/50d78f4c-130f-4751-8a63-e4267644ad5f.png)
3. 从上到下分别为：**网络IP**、**保护模式**（关掉后谁都能访问Redis）、**端口号![配置文件](../../图床/b06659f4-6ade-4a35-ad25-ccd70a2a9d97.png)**
4. **daemonize**（只在Linux）**守护进程模式**，yes和no开关。简单来说就是关掉后，后台依然保留Redis进程。如果需要开启，则需要到**pidfile**处指定后台进程文件
5. 这里的**logfile**为日志文件名，**databases**为默认数据库数量![配置文件](../../图床/78142bde-7521-4dd8-b462-35f225722bbb.png)
6. **第一行**的意思是，如果**九百秒内**，有**一个key**进行**增删改**，就进行**持久化操作**。**第二行**的意思是，如果**三百秒内**，有**十个key**进行**增删改**，就进行**持久化操作**。**第三行的**意思是**六十秒内**，有**一万个key**进行**增删改**，就进行**持久化操作**![配置文件](../../图床/8cf1140d-d949-4887-a526-2bfcb29f77bb.png)
7. 从上到下，1.快照保存**异常**，**是否继续工作**。2.是否**压缩rdb**文件，会**消耗**部分**cpu**性能。3.**保存rdb**文件，进行**错误检查**。最后一个是rdb文件保存目录![配置文件](../../图床/b55aaee1-e2c5-4677-8cb3-b3ac05de2eac.png)
8. 这里是存放密码的地方，**默认**redis**是没有密码**的![配置文件](../../图床/8016d8d8-d788-4a7a-a5aa-34e7fb20404b.png)
9. 默认最大的**客户端连接数量**![配置文件](../../图床/c137fec2-1214-4923-81a8-cc6d421dccc9.png)
10. 配置**最大内存**![配置文件](../../图床/533d7773-dff5-4e7c-9ac7-86eac4cb1bea.png)
11. 内存满了处理策略。
    ![配置文件](../../图床/17264bbf-9d18-4f53-a7d2-1ac7b68a1fab.png)
    1. volatile-lru：只对设置了过期时间的key进行lr（默认值）
    2. allkeys--lru：删除lru算法的key
    3. volatile-random：随机删除即将过期key
    4. allkeys-random：随机删除
    5. volatile-ttl：删除即将过期的
    6. noeviction：永不过期，返回错误
12. 从上到下，1.**AOF**（持久化）模式。2.持久化的**文件名**。3.同步时间，每秒一次，但是**可能会丢失这一秒的数据**（可修改为**always**，就是**每次修改**都会**保存一次**。修改为**no**，则同步**由系统决定**）。![配置文件](../../图床/f90d6b41-5428-41d5-a62b-137da0356291.png)
13. aof模式下，当aof文件大于64MB，就会开一个新的文件来写![配置文件](../../图床/452cd260-ca2c-4c19-9592-6011022bf1f1.png)

## 数据持久化

由于Redis的**数据**全部**存储**在**内存**中，当**设备断电**后，**数据**都将**不存在**，因此就需要将**内存数据写入硬盘**中，进行**数据持久化操作**

### RDB

在指定时间间隔内，将内存数据写进Redis（关闭redis本身也会触发），也就是**Snapshot快照**，恢复时将快照文件读取到内存中。Redis默认都采取RDB。

- 在Redis中，会单独开一个**子线程**去专门处理这个持久化工作，存储的时候会在**临时文件存储**，存储完毕后，在**将临时文件覆盖掉之前的保存文件**。

恢复rdb文件的方法，就是把**rdb文件放在redis的启动目录**下，redis在启动的时候会检测，**检测到后自动恢复数据**

**缺点**是在进行**持久化操作**的**时候**，**服务器宕机**，那么**数据可能会丢失**

### AOF

**所有命令都记录下来**。和RDB一样，会单独开一个子线程去保存。把所有命令记录下来，在恢复的时候就是把文件中的命令再执行一遍。当然不包括读操作。

该模式**默认是关闭**，如果要启动，就要**去配置文件手动开启**。

开启方法参考前面的**《Redis配置文件》**笔记。

如果aof文件有错误，redis无法启动，可以使用redis自带的一个修复工具，**redis-check-aof**。（修复的原理，就是**遍历每一行**，**哪一行异常**，**就删除哪一行**。因此会带来部分的操作丢失，**导致数据的不正确**）

缺点。占用容量大、修复速度慢、运行效率低下。因此默认采用RDB模式

## Redis发布订阅模式

简单来说是一个**信息通信模式**，发送者发送信息，订阅者接受信息。 具体来说，就是一群redis服务器，开启一条通道，当一台redis向通道发送信息，那么其他监听这个通道的redis服务器都会获取到。

1. 可以大致参考一下图片![发布订阅模式](../../图床/ad302071-f5e1-4578-8aa3-25cd3bc0317e.png)
2. 代码端就是这样![发布订阅模式代码](../../图床/78e7daf3-565b-4216-8655-ab202181c2fa.png)

### 使用场景

1. 可以用来做**实时聊天频道**

如果场景复杂就使用**消息中间件**，不要硬上。简单了解原理知道是个什么即可。

具体**命令、实现**等前往[视频](https://www.bilibili.com/video/BV1S54y1R7SB?spm_id_from=333.788.player.switch&vd_source=95c95b2b45956217a529f886ca23dd35&p=31)观看，这里不做记录

## Redis主从复制

